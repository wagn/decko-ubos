{
    "type" : "app",

    "roles" : {
        "apache2" : {
            "defaultcontext" : "/wagn",
            "depends" : [
                "imagemagick",
                "memcached",
                "mod_xsendfile",
                "passenger",
                "ruby",
                "ruby-bundler",
                "ruby-mysql",
#        "nodejs",
#        "git"
            ],
            "apache2modules" : [
                "passenger",
                "expires",
                "xsendfile",
                "headers"
            ],
            "wellknown" : {
                "robotstxt" : {
                    "disallow" : [
                        "/card/",
                        "/admin/",
                        "/account/",
                        "/*?*"
                    ]
                }
            },
            "appconfigitems" : [
                {
                    "type" : "file",
                    "name" : "${appconfig.apache2.appconfigfragmentfile}",
                    "template"     : "tmpl/htaccess.tmpl",
                    "templatelang" : "varsubst"
                },
                {
                    "type": "symlink",
                    "source": "/usr/share/decko/wagn/wagn/rails/$1",
                    "names": [
                        "assets"
                    ]
                },
                {
                    "type": "directory",
                    "names": [
                        "${appconfig.apache2.dir}/mod",
                        "${appconfig.apache2.dir}/config"
                    ]
                },
                {
                    "type": "symlink",
                    "source": "/usr/share/decko/web/$1",
                    "names": [
                        ".bundle",
                        "Gemfile",
                        "Rakefile",
                        "config/boot.rb",
#            "config/airbrake.key", <- Can this be factored out into an accessory?
                        "config/environment.rb",
                        "script"
                    ]
                },
#                { <- Can this be factored out into an accessory?
#                    "type": "symlink",
#                    "target": "/usr/share/decko/web/$1",
#                    "names": [
#                        "mod/airbrake"
#                    ]
#                },
                {
                    "type" : "file",
                    "name" : "config/database.yml",
                    "template"     : "tmpl/database.yml.tmpl",
                    "templatelang" : "varsubst"
                },
#                { <- Can this be factored out into an accessory?
#                    "type": "file",
#                    "name": "config/newrelic.yml",
#                    "template": "tmpl/newrelic.yml.tmpl",
#                    "templatelang": "varsubst"
#                },
                {
                    "type" : "file",
                    "name" : "config/application.rb",
                    "template"     : "tmpl/application.rb.tmpl",
                    "templatelang" : "varsubst"
                },
                {
                    "type"  : "directory",
                    "uname" : "${apache2.uname}",
                    "gname" : "${apache2.gname}",
                    "mode"  : "0755",
                    "name"  : "files",
                    "retention":       "backup",
                    "retentionbucket": "uploads"
                },
                {
                    "type"  : "directory",
                    "uname" : "${apache2.uname}",
                    "gname" : "${apache2.gname}",
                    "mode"  : "0755",
                    "name"  : "tmp"
                },
                {
                    "type": "file",
                    "uname" : "${apache2.uname}",
                    "gname" : "${apache2.gname}",

                    "target": "$1",
                    "names" : [
                         "tmpl/config.ru",
                         "tmpl/Gemfile.lock",
                         "tmpl/restart.txt"
                    ]
                },
                {
                    "type": "file",
                    "uname": "${apache2.uname}",
                    "gname": "${apache2.gname}",
                    "mode": "0666",
                    "name": "/var/log/decko/${appconfig.appconfigid}.log"
                }
            ],
            "installers" : [
                {
                    "type"   : "perlscript",
                    "source" : "bin/migrate.pl"
                }
            ],
            "upgraders" : [
                {
                    "type"   : "perlscript",
                    "source" : "bin/migrate.pl"
                }
            ]
        },

        "mysql" : {
            "appconfigitems" : [
                {
                    "type"       : "database",
                    "name"       : "maindb",
                    "retentionpolicy"  : "keep",
                    "retentionbucket"  : "maindb",
                    "privileges" : "create, alter, drop, index, select, insert, update, delete"
                }
            ],
            "installers" : [
                {
                    "name"   : "maindb",
                    "type"   : "sqlscript",
                    "source" : "sql/bootstrap.sql"
                }
            ]
        }
    }
}
