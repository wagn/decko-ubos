developer=http://grasscommons.org/
url=http://wagn.org/
maintainer=${developer}
pkgname=decko
pkgver=1.21.0
pkgrel=1
pkgdesc="Wiki platform for collaborating to build custom web systems"
arch=('any')
license=("GPL")
source=("https://github.com/wagn/wagn/archive/v${pkgver}.zip")
depends=(
    'nodejs'
    'git'
    'smtp-server' )
options=('!strip')
sha512sums=('3b9fbd35bd3a31f526fd43689b80f920d37c25cbac84dda00f300066c1feeb4e277729d93e2852ed70615b7221557e7d92d30e96872d93d2c288ffcd325202a8')

build() {
    # Gemfile is generated here, as we know only here where the Wagn sources are
    cat > Gemfile <<END
#
# Automatically generated by decko-ubos PKGBUILD, do not modify
#

source 'http://rubygems.org'

gem 'card'       , :path=>'${srcdir}/wagn-${pkgver}/card'
gem 'wagn'       , :path=>'${srcdir}/wagn-${pkgver}/wagn'
gem 'decko-rails', :path=>'${srcdir}/wagn-${pkgver}/decko-rails'

gem 'therubyracer'
gem 'newrelic_rpm'

gem 'mysql2', '~> 0.3.18'

gem 'dalli'

Dir.glob( 'mod/**{,/*/**}/Gemfile' ).each do |gemfile|
  instance_eval File.read(gemfile)
end

END

    [[ -d .bundle ]] || mkdir .bundle
    bundle install --path $(pwd)/.bundle
}

package() {
# Manifest
    mkdir -p ${pkgdir}/var/lib/ubos/manifests
    install -m0644 ${startdir}/ubos-manifest.json ${pkgdir}/var/lib/ubos/manifests/${pkgname}.json

# Icons
    mkdir -p ${pkgdir}/srv/http/_appicons/$pkgname
    install -m644 ${startdir}/appicons/{72x72,144x144}.png ${pkgdir}/srv/http/_appicons/$pkgname/

# Data directory
    mkdir -p ${pkgdir}/var/lib/${pkgname}

# Templates
    mkdir -p ${pkgdir}/usr/share/${pkgname}/tmpl
    cp ${startdir}/tmpl/* ${pkgdir}/usr/share/${pkgname}/tmpl/

# Initial SQL
    mkdir -p ${pkgdir}/usr/share/${pkgname}/sql
    cp ${startdir}/sql/bootstrap.sql ${pkgdir}/usr/share/${pkgname}/sql/

# Code
    mkdir -p ${pkgdir}/usr/share/${pkgname}/web
    cp -r -p ${startdir}/web/* ${pkgdir}/usr/share/${pkgname}/web/
    mkdir -p ${pkgdir}/usr/share/${pkgname}/bin
    install -m755 ${startdir}/bin/* ${pkgdir}/usr/share/${pkgname}/bin/

# Logs
    # Should move to systemd journal some day
    mkdir -p ${pkgdir}/var/log/${pkgname}
    chown http:http ${pkgdir}/var/log/${pkgname}

# Gems
    rsync -a --exclude 'cache/' ${srcdir}/.bundle ${pkgdir}/usr/share/${pkgname}/
}

